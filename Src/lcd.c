#include "main.h"

#include "u8g2.h"

#define u8 unsigned char

static u8 iicAddr=0x78;
//#define iicAddr 0x3C
extern I2C_HandleTypeDef hi2c1;

static u8 _lcdOnline = 1;

void delay_us(u8 dly)
{
	//HAL_Delay(dly);
}
void lcdOnline()
{
	_lcdOnline = 1;
}

void lcdOffline()
{
	_lcdOnline = 0;
}

void scanAddr()
{
	unsigned char buf[2];
	buf[0] = 0x00;
	for(iicAddr=0;iicAddr<0xFF;iicAddr+=2)
	{
		if(HAL_OK == HAL_I2C_Master_Transmit(&hi2c1,iicAddr,buf,1,0xFFFF))
			break;
	}
	HAL_I2C_Master_Receive(&hi2c1,iicAddr,buf,2,0xFFFF);
	if(buf[0] == 0x5A)
	{
		buf[1] = 0x5A;
	}
}

void IICWrite(u8 dat[2],u8 cnt)
{
		HAL_I2C_Master_Transmit(&hi2c1,iicAddr,dat,2,0xFFFF);
}
//sh1106内部iic地址0x78,SA0为1,则是0x7A
void writeCmd(u8 Data)
{ 
	unsigned char buf[2];
	buf[0] = 0x00;buf[1] = Data;
	IICWrite(buf,2);
}


void writeData(u8 Data)
{
	unsigned char buf[2];
	buf[0] = 0x40;buf[1] = Data;
	IICWrite(buf,2);
}

const u8 F6x8[] =
{
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00 ,   // sp
    0x00, 0x00, 0x00, 0x2f, 0x00, 0x00 ,   // !
    0x00, 0x00, 0x07, 0x00, 0x07, 0x00 ,   // "
    0x00, 0x14, 0x7f, 0x14, 0x7f, 0x14 ,   // #
    0x00, 0x24, 0x2a, 0x7f, 0x2a, 0x12 ,   // $
    0x00, 0x62, 0x64, 0x08, 0x13, 0x23 ,   // %
    0x00, 0x36, 0x49, 0x55, 0x22, 0x50 ,   // &
    0x00, 0x00, 0x05, 0x03, 0x00, 0x00 ,   // '
    0x00, 0x00, 0x1c, 0x22, 0x41, 0x00 ,   // (
    0x00, 0x00, 0x41, 0x22, 0x1c, 0x00 ,   // )
    0x00, 0x14, 0x08, 0x3E, 0x08, 0x14 ,   // *
    0x00, 0x08, 0x08, 0x3E, 0x08, 0x08 ,   // +
    0x00, 0x00, 0x00, 0xA0, 0x60, 0x00 ,   // ,
    0x00, 0x08, 0x08, 0x08, 0x08, 0x08 ,   // -
    0x00, 0x00, 0x60, 0x60, 0x00, 0x00 ,   // .
    0x00, 0x20, 0x10, 0x08, 0x04, 0x02 ,   // /
    0x00, 0x3E, 0x51, 0x49, 0x45, 0x3E ,   // 0
    0x00, 0x00, 0x42, 0x7F, 0x40, 0x00 ,   // 1
    0x00, 0x42, 0x61, 0x51, 0x49, 0x46 ,   // 2
    0x00, 0x21, 0x41, 0x45, 0x4B, 0x31 ,   // 3
    0x00, 0x18, 0x14, 0x12, 0x7F, 0x10 ,   // 4
    0x00, 0x27, 0x45, 0x45, 0x45, 0x39 ,   // 5
    0x00, 0x3C, 0x4A, 0x49, 0x49, 0x30 ,   // 6
    0x00, 0x01, 0x71, 0x09, 0x05, 0x03 ,   // 7
    0x00, 0x36, 0x49, 0x49, 0x49, 0x36 ,   // 8
    0x00, 0x06, 0x49, 0x49, 0x29, 0x1E ,   // 9
    0x00, 0x00, 0x36, 0x36, 0x00, 0x00 ,   // :
    0x00, 0x00, 0x56, 0x36, 0x00, 0x00 ,   // ;
    0x00, 0x08, 0x14, 0x22, 0x41, 0x00 ,   // <
    0x00, 0x14, 0x14, 0x14, 0x14, 0x14 ,   // =
    0x00, 0x00, 0x41, 0x22, 0x14, 0x08 ,   // >
    0x00, 0x02, 0x01, 0x51, 0x09, 0x06 ,   // ?
    0x00, 0x32, 0x49, 0x59, 0x51, 0x3E ,   // @
    0x00, 0x7C, 0x12, 0x11, 0x12, 0x7C ,   // A
    0x00, 0x7F, 0x49, 0x49, 0x49, 0x36 ,   // B
    0x00, 0x3E, 0x41, 0x41, 0x41, 0x22 ,   // C
    0x00, 0x7F, 0x41, 0x41, 0x22, 0x1C ,   // D
    0x00, 0x7F, 0x49, 0x49, 0x49, 0x41 ,   // E
    0x00, 0x7F, 0x09, 0x09, 0x09, 0x01 ,   // F
    0x00, 0x3E, 0x41, 0x49, 0x49, 0x7A ,   // G
    0x00, 0x7F, 0x08, 0x08, 0x08, 0x7F ,   // H
    0x00, 0x00, 0x41, 0x7F, 0x41, 0x00 ,   // I
    0x00, 0x20, 0x40, 0x41, 0x3F, 0x01 ,   // J
    0x00, 0x7F, 0x08, 0x14, 0x22, 0x41 ,   // K
    0x00, 0x7F, 0x40, 0x40, 0x40, 0x40 ,   // L
    0x00, 0x7F, 0x02, 0x0C, 0x02, 0x7F ,   // M
    0x00, 0x7F, 0x04, 0x08, 0x10, 0x7F ,   // N
    0x00, 0x3E, 0x41, 0x41, 0x41, 0x3E ,   // O
    0x00, 0x7F, 0x09, 0x09, 0x09, 0x06 ,   // P
    0x00, 0x3E, 0x41, 0x51, 0x21, 0x5E ,   // Q
    0x00, 0x7F, 0x09, 0x19, 0x29, 0x46 ,   // R
    0x00, 0x46, 0x49, 0x49, 0x49, 0x31 ,   // S
    0x00, 0x01, 0x01, 0x7F, 0x01, 0x01 ,   // T
    0x00, 0x3F, 0x40, 0x40, 0x40, 0x3F ,   // U
    0x00, 0x1F, 0x20, 0x40, 0x20, 0x1F ,   // V
    0x00, 0x3F, 0x40, 0x38, 0x40, 0x3F ,   // W
    0x00, 0x63, 0x14, 0x08, 0x14, 0x63 ,   // X
    0x00, 0x07, 0x08, 0x70, 0x08, 0x07 ,   // Y
    0x00, 0x61, 0x51, 0x49, 0x45, 0x43 ,   // Z
    0x00, 0x00, 0x7F, 0x41, 0x41, 0x00 ,   // [
    0x00, 0x55, 0x2A, 0x55, 0x2A, 0x55 ,   // 55
    0x00, 0x00, 0x41, 0x41, 0x7F, 0x00 ,   // ]
    0x00, 0x04, 0x02, 0x01, 0x02, 0x04 ,   // ^
    0x00, 0x40, 0x40, 0x40, 0x40, 0x40 ,   // _
    0x00, 0x00, 0x01, 0x02, 0x04, 0x00 ,   // '
    0x00, 0x20, 0x54, 0x54, 0x54, 0x78 ,   // a
    0x00, 0x7F, 0x48, 0x44, 0x44, 0x38 ,   // b
    0x00, 0x38, 0x44, 0x44, 0x44, 0x20 ,   // c
    0x00, 0x38, 0x44, 0x44, 0x48, 0x7F ,   // d
    0x00, 0x38, 0x54, 0x54, 0x54, 0x18 ,   // e
    0x00, 0x08, 0x7E, 0x09, 0x01, 0x02 ,   // f
    0x00, 0x18, 0xA4, 0xA4, 0xA4, 0x7C ,   // g
    0x00, 0x7F, 0x08, 0x04, 0x04, 0x78 ,   // h
    0x00, 0x00, 0x44, 0x7D, 0x40, 0x00 ,   // i
    0x00, 0x40, 0x80, 0x84, 0x7D, 0x00 ,   // j
    0x00, 0x7F, 0x10, 0x28, 0x44, 0x00 ,   // k
    0x00, 0x00, 0x41, 0x7F, 0x40, 0x00 ,   // l
    0x00, 0x7C, 0x04, 0x18, 0x04, 0x78 ,   // m
    0x00, 0x7C, 0x08, 0x04, 0x04, 0x78 ,   // n
    0x00, 0x38, 0x44, 0x44, 0x44, 0x38 ,   // o
    0x00, 0xFC, 0x24, 0x24, 0x24, 0x18 ,   // p
    0x00, 0x18, 0x24, 0x24, 0x18, 0xFC ,   // q
    0x00, 0x7C, 0x08, 0x04, 0x04, 0x08 ,   // r
    0x00, 0x48, 0x54, 0x54, 0x54, 0x20 ,   // s
    0x00, 0x04, 0x3F, 0x44, 0x40, 0x20 ,   // t
    0x00, 0x3C, 0x40, 0x40, 0x20, 0x7C ,   // u
    0x00, 0x1C, 0x20, 0x40, 0x20, 0x1C ,   // v
    0x00, 0x3C, 0x40, 0x30, 0x40, 0x3C ,   // w
    0x00, 0x44, 0x28, 0x10, 0x28, 0x44 ,   // x
    0x00, 0x1C, 0xA0, 0xA0, 0xA0, 0x7C ,   // y
    0x00, 0x44, 0x64, 0x54, 0x4C, 0x44 ,   // z
    0x14, 0x14, 0x14, 0x14, 0x14, 0x14     // horiz lines
};
u8 hz1[]={//汉 12x16
0x11,0x22,0x00,0x02,0x3E,0xC2,0x02,0x82,0x62,0x1E,0x00,0x00,0x04,0x02,0x09,0x08,
0x04,0x02,0x01,0x02,0x04,0x08,0x08,0x00,
};

void lcdSetXY(uint8_t x, uint8_t y)
{
		x=x+2;//sh1106需要+2
    writeCmd(0xb0 + y);  
	
    writeCmd(((x & 0xf0) >> 4) | 0x10);
    writeCmd(x & 0x0f); 
}
void lcdClr()
{
	u8 i,j;
	for(i=0;i<64/8;i++){
		lcdSetXY(0,i);
		for(j=0;j<128;j++)
			writeData(0x00);
	}
	
}
//==============================================================
//函数名：LCD_P6x8Str(u8 x,u8 y,u8 *p)
//功能描述：写入一组标准ASCII字符串
//参数：显示的位置（x,y），y为页范围0～7，要显示的字符串
//返回：无
//==============================================================  
void LcdEnStr(u8 x,u8 y,u8 *ch)
{
	u8 c=0,i=0,j=0;
	if( !_lcdOnline)
		return;
	while (*(ch+j)!='\0')
	{    
		c =*(ch+j)-32;
		if(x>126)
		{
			x=0;
			y++;
		}
		lcdSetXY(x,y);    
		for(i=0;i<6;i++) 
		{
			writeData(*(F6x8+c*6+i));
		}
		x+=6;
		j++;
	}
}

void pic13(void)
{
	u8 i,j,k;
	k=0;
	
	for(j=0;j<16/8;j++)
	{
		lcdSetXY(0,j);
 		for(i=0;i<12;i++)		  				
		{
			writeData(hz1[k++]);
		}
	}
}
void lcdInit(void)//ssd1306
{
	scanAddr();
	writeCmd(0xae);//--turn off oled panel
  writeCmd(0x00);//---set low column address
  writeCmd(0x10);//---set high column address
  writeCmd(0x40);//--set start line address  Set Mapping RAM Display Start Line (0x00~0x3F)
  writeCmd(0x81);//--set contrast control register
  writeCmd(0xcf); // Set SEG Output Current Brightness
  writeCmd(0xa1);//--Set SEG/Column Mapping     0xa0???? 0xa1??
  writeCmd(0xc8);//Set COM/Row Scan Direction   0xc0???? 0xc8??
  writeCmd(0xa6);//--set normal display
  writeCmd(0xa8);//--set multiplex ratio(1 to 64)
  writeCmd(0x3f);//--1/64 duty
  writeCmd(0xd3);//-set display offset	Shift Mapping RAM Counter (0x00~0x3F)
  writeCmd(0x00);//-not offset
  writeCmd(0xd5);//--set display clock divide ratio/oscillator frequency
  writeCmd(0x80);//--set divide ratio, Set Clock as 100 Frames/Sec
  writeCmd(0xd9);//--set pre-charge period
  writeCmd(0xf1);//Set Pre-Charge as 15 Clocks & Discharge as 1 Clock
  writeCmd(0xda);//--set com pins hardware configuration
  writeCmd(0x12);
  writeCmd(0xdb);//--set vcomh
  writeCmd(0x40);//Set VCOM Deselect Level
  writeCmd(0x20);//-Set Page Addressing Mode (0x00/0x01/0x02)
  writeCmd(0x02);//
  writeCmd(0x8d);//--set Charge Pump enable/disable
  writeCmd(0x14);//--set(0x10) disable
  writeCmd(0xa4);// Disable Entire Display On (0xa4/0xa5)
  writeCmd(0xa6);// Disable Inverse Display On (0xa6/a7) 
  writeCmd(0xaf);//--turn on oled pane
	lcdClr();
	LcdEnStr(0,0,"hello");
	
}
void lcdInit_sh1106(void) //sh1106
{
		scanAddr();
    writeCmd(0xae);   //--turn off oled panel

    writeCmd(0x00);   //--set low column address
    writeCmd(0x10);   //--set high column address

    writeCmd(0x40);   //--set start line address

    writeCmd(0xb0);   //--set page address

    writeCmd(0x81);   //--set contrast control register
    writeCmd(0xff);

	  writeCmd(0xa1);   //--set segment re-map A1:127 to 0   a0:0 to seg127
    writeCmd(0xa6);   //--set  Normal/Reverse Display: (A6H -A7H) //A6--黑底

		writeCmd(0xc8);   //--set C8:com(N-1)to com0  c0:com0 to com(N-1)

    writeCmd(0xa8);   //--set multiples ratio(1to64)
    writeCmd(0x3f);   //--1/64 duty

    writeCmd(0xd3);   //--set display offset
    writeCmd(0x00);   //--not offset

    writeCmd(0xd5);   //--set display clock divide ratio/oscillator frequency
    writeCmd(0x80);   //--set divide ratio

    writeCmd(0xd9);   //--set pre-charge period
    writeCmd(0xf1);//writeCmd(0x22);

    writeCmd(0xda);   //--set com pins hardware configuration
    writeCmd(0x12);

    writeCmd(0xdb);   //--set vcomh
    writeCmd(0x40);

		writeCmd(0x20);//-Set Page Addressing Mode (0x00/0x01/0x02)
		writeCmd(0x02);//

    writeCmd(0x8d);   //--set chare pump enable/disable
    writeCmd(0x14);   //--set(0x14) enable/(0x10)disable

    writeCmd(0xaf);   //--turn on oled panel
		
		delay_us(50);
		lcdClr();
		pic13();
}


